{% extends 'courses/base.html' %}

{% block title %}{{ course.course_name }} - èª²ç¨‹è©³æƒ…{% endblock %}

{% block content %}
<div class="mb-3">
    <a href="{% url 'courses:course_list' %}" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i> è¿”å›èª²ç¨‹åˆ—è¡¨
    </a>
</div>

<h1>{{ course.course_name }}</h1>

<div class="row mb-5">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">èª²ç¨‹åŸºæœ¬ä¿¡æ¯</h5>
            </div>
            <div class="card-body">
                <p><strong>èª²è™Ÿï¼š</strong> {{ course.course_code }}</p>
                <p><strong>èª²åï¼š</strong> {{ course.course_name }}</p>
                <p><strong>ä»»èª²æ•™å¸«ï¼š</strong> {{ course.teacher.user.get_full_name }}</p>
                <p><strong>å­¸åˆ†ï¼š</strong> <span class="badge bg-info">{{ course.credits }}</span></p>
                <p><strong>æœ€å¤§é¸ä¿®äººæ•¸ï¼š</strong> {{ course.max_students }}</p>
                <p><strong>å­¸æœŸï¼š</strong> {{ course.semester }}</p>
                {% if course.description %}
                    <p><strong>èª²ç¨‹æè¿°ï¼š</strong></p>
                    <p>{{ course.description }}</p>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">èª²ç¨‹ç‹€æ…‹</h5>
            </div>
            <div class="card-body">
                <p><strong>ç›®å‰é¸ä¿®äººæ•¸ï¼š</strong></p>
                <h3>
                    <span class="badge bg-primary" style="font-size: 20px;">
                        {{ course.get_current_enrollment_count }}
                    </span>
                    <span style="color: #999;">/{{ course.max_students }}</span>
                </h3>
                <p class="mt-3">
                    <strong>ç‹€æ…‹ï¼š</strong>
                    {% if course.get_current_enrollment_count >= course.max_students %}
                        <span class="badge bg-danger">å·²æ»¿ç­</span>
                    {% else %}
                        <span class="badge bg-success">å°šæœ‰åé¡</span>
                    {% endif %}
                </p>
                
                {% if user.is_authenticated and user.profile.role == 'student' %}
                    {% with user_enrolled=enrollments|dictsort:"user_id" %}
                        {% if user in enrollments|dictsort:"user_id" %}
                            <form method="POST" action="{% url 'courses:drop_course' enrollment.id %}" style="margin-top: 10px;">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('ç¢ºå®šé€€é¸å—ï¼Ÿ');">
                                    é€€é¸èª²ç¨‹
                                </button>
                            </form>
                        {% else %}
                            <a href="{% url 'courses:add_enrollment' course.id %}" class="btn btn-success btn-sm mt-3">
                                <i class="fas fa-plus"></i> é¸èª²
                            </a>
                        {% endif %}
                    {% endwith %}
                {% endif %}
            </div>
        </div>
    </div>
</div>

<h3>ğŸ“‹ ä¿®èª²å­¸ç”Ÿåå–®</h3>

{% if enrollments %}
    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>å§“å</th>
                    <th>æœŸä¸­åˆ†æ•¸</th>
                    <th>æœŸæœ«åˆ†æ•¸</th>
                    <th>ç§‘ç›®åˆ†æ•¸</th>
                    <th>é¸èª²æ™‚é–“</th>
                </tr>
            </thead>
            <tbody>
                {% for enrollment in enrollments %}
                    <tr>
                        <td>{{ enrollment.user.get_full_name }}</td>
                        <td>
                            {% if enrollment.midterm_score %}
                                {{ enrollment.midterm_score }}
                            {% else %}
                                <span class="badge bg-secondary">æœªç™»éŒ„</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if enrollment.final_score %}
                                {{ enrollment.final_score }}
                            {% else %}
                                <span class="badge bg-secondary">æœªç™»éŒ„</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if enrollment.get_total_score %}
                                <strong class="text-success">{{ enrollment.get_total_score }}</strong>
                            {% else %}
                                <span class="badge bg-warning">å¾…ç™»éŒ„</span>
                            {% endif %}
                        </td>
                        <td>
                            {{ enrollment.enrolled_at|date:"Y-m-d H:i" }}
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
{% else %}
    <div class="alert alert-info" role="alert">
        <i class="fas fa-info-circle"></i> ç›®å‰é‚„æ²’æœ‰å­¸ç”Ÿé¸ä¿®æ­¤èª²ç¨‹ã€‚
    </div>
{% endif %}

<!-- èª²ç¨‹ç•™è¨€å€åŸŸ -->
<div class="mt-5">
    <h3>ğŸ’¬ èª²ç¨‹ç•™è¨€</h3>
    
    {% if user.is_authenticated and can_comment %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    {% if user_comment %}
                        ç·¨è¼¯æˆ‘çš„ç•™è¨€
                    {% else %}
                        ç™¼è¡¨ç•™è¨€
                    {% endif %}
                </h5>
            </div>
            <div class="card-body">
                <form method="POST">
                    {% csrf_token %}
                    {% if user_comment %}
                        <input type="hidden" name="comment_id" value="{{ user_comment.id }}">
                        <textarea name="content" class="form-control" rows="3" required>{{ user_comment.content }}</textarea>
                        <button type="submit" class="btn btn-primary mt-3">æ›´æ–°ç•™è¨€</button>
                    {% else %}
                        <textarea name="content" class="form-control" rows="3" placeholder="è¼¸å…¥ä½ çš„ç•™è¨€..." required></textarea>
                        <button type="submit" class="btn btn-primary mt-3">ç™¼è¡¨ç•™è¨€</button>
                    {% endif %}
                </form>
            </div>
        </div>
    {% elif user.is_authenticated and not can_comment %}
        <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle"></i> åªæœ‰é¸ä¿®æ­¤èª²ç¨‹çš„å­¸ç”Ÿæ‰èƒ½ç™¼è¡¨ç•™è¨€ã€‚
        </div>
    {% else %}
        <div class="alert alert-info">
            <i class="fas fa-info-circle"></i> <a href="{% url 'courses:login' %}">ç™»å…¥</a>å¾Œæ‰èƒ½ç™¼è¡¨ç•™è¨€ã€‚
        </div>
    {% endif %}
    
    <!-- æ‰€æœ‰ç•™è¨€ -->
    {% if comments %}
        <div class="mt-4">
            {% for comment in comments %}
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title">{{ comment.user.get_full_name }}</h6>
                                <small class="text-muted">{{ comment.created_at|date:"Y-m-d H:i" }}</small>
                                {% if comment.created_at != comment.updated_at %}
                                    <small class="text-muted">(å·²ç·¨è¼¯)</small>
                                {% endif %}
                            </div>
                            {% if user.is_authenticated and user == comment.user %}
                                <button class="btn btn-sm btn-outline-primary" data-bs-toggle="collapse" data-bs-target="#edit-{{ comment.id }}">
                                    ç·¨è¼¯
                                </button>
                            {% endif %}
                        </div>
                        
                        <p class="card-text mt-2">{{ comment.content }}</p>
                        
                        {% if user.is_authenticated and user == comment.user %}
                            <div class="collapse mt-3" id="edit-{{ comment.id }}">
                                <form method="POST">
                                    {% csrf_token %}
                                    <input type="hidden" name="comment_id" value="{{ comment.id }}">
                                    <textarea name="content" class="form-control" rows="3" required>{{ comment.content }}</textarea>
                                    <button type="submit" class="btn btn-sm btn-primary mt-2">ä¿å­˜</button>
                                </form>
                            </div>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="alert alert-secondary">
            <i class="fas fa-comment-slash"></i> é‚„æ²’æœ‰ç•™è¨€ã€‚
        </div>
    {% endif %}
</div>

<div class="mt-5">
    <a href="{% url 'courses:course_list' %}" class="btn btn-secondary">è¿”å›èª²ç¨‹åˆ—è¡¨</a>
</div>
{% endblock %}
